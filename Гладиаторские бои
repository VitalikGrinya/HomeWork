namespace GladiatorsFights
{
    internal class Program
    {
        static void Main(string[] args)
        {
            Battle battle = new Battle();
            battle.Fight();
        }
    }

    abstract class Warrior
    {
        public Warrior(string name, int health, int damage)
        {
            Name = name;
            Health = health;
            Damage = damage;
        }

        public string Ability { get; protected set; }
        public string Name { get; protected set; }
        public int Id { get; protected set; }
        public int Health { get; protected set; }
        public int Damage { get; protected set; }

        public abstract Warrior Clone();

        public virtual void ShowGladiatorInfo()
        {
            Console.WriteLine($"{Id}. {Name}. Здоровье - {Health}. Сила - {Damage}.\n{Ability}.");
        }

        public virtual void TakeDamage(int damage)
        {
            int minHealthValue = 0;

            Health -= damage;

            if (Health < minHealthValue)
            {
                Health = minHealthValue;
            }
        }

        public virtual void Attack(Warrior warrior){ }

        public virtual void UseAbility() { }
    }

    class Assassin : Warrior
    {
        private string _name = "Убийца";

        private int _health = 100;
        private int _damage = 18;
        private int _id = 1;

        public Assassin(string name, int health, int damage) : base(name, health, damage)
        {
            Id = _id;
            Name = _name;
            Health = _health;
            Damage = _damage;
            Ability = "Особая способность - Проворство. Увеличивает силу удара в два раза";
        }

        private void UseIndividualAbility()
        {
            int minChanceValue = 1;
            int maxChanceValue = 2;
            int attackChance = 1;
            int individualAttack = 2;

            if (Utilites.GenerateInt(minChanceValue, maxChanceValue) == attackChance)
            {
                Damage = _damage * individualAttack;
            }
            else
            {
                Damage = _damage;
            }
        }

        public override void Attack(Warrior assasin)
        {
            assasin.TakeDamage(Damage);
            UseIndividualAbility();
        }

        public override Warrior Clone()
        {
            return new Assassin(_name, _health, _damage);
        }
    }

    class Berserk : Warrior
    {
        private string _name = "Берсерк";

        private int _health = 500;
        private int _damage = 10;
        private int _id = 2;

        public Berserk(string name, int health, int damage) : base(name, health, damage)
        {
            Id = _id;
            Name = _name;
            Health = _health;
            Damage = _damage;
            Ability = "Особая способность - Ярость. При накоплении ярости атакует дважды";
        }

        public void UseIndividualAbility()
        {
            int individualAttack = 2;
            int fury = 2;
            int furyAttack = _damage * individualAttack;

            for(int i = 0; i <= fury; i++)
            {
                if (i == fury)
                {
                    Damage = furyAttack;
                }
                else if (i <= fury) 
                {
                    Damage = _damage;
                }
            }
        }

        public override void Attack(Warrior berserk)
        {
            berserk.TakeDamage(Damage);
            UseIndividualAbility();
        }

        public override Warrior Clone()
        {
            return new Berserk(_name, _health, _damage);
        }
    }

    class Knight : Warrior
    {
        private string _name = "Рыцарь";

        private int _health = 150;
        private int _damage = 20;
        private int _id = 3;

        public Knight(string name, int health, int damage) : base(name, health, damage)
        {
            Id = _id;
            Name = _name;
            Health = _health;
            Damage = _damage;
            Ability = "Особая способность - на грани смерти восстанавливает часть жизней";
        }

        public void UseIndividualAbility()
        {
            int deathHealthValue = 0;
            int minHealthValue = 25;
            int holyPower = 40;

            if (Health <= minHealthValue && Health > deathHealthValue)
            {
                Damage = holyPower;
            }
        }

        public override void Attack(Warrior knight)
        {
            knight.TakeDamage(Damage);
            UseIndividualAbility();
        }

        public override Warrior Clone()
        {
            return new Knight(_name, _health, _damage);
        }
    }

    class Samurai : Warrior
    {
        private string _name = "Самурай";

        private int _health = 100;
        private int _damage = 25;
        private int _id = 4;

        public Samurai(string name, int health, int damage) : base(name, health, damage)
        {
            Id = _id;
            Name = _name;
            Health = _health;
            Damage = _damage;
            Ability = "Особая способность - шанс критического урона 33%";
        }

        public void UseIndividualAbility()
        {
            Damage = _damage;

            int maxChance = 3;
            int minChance = 1;
            int criticalDamageChance = 1;
            int criticalDamagePower = 2;

            if (Utilites.GenerateInt(minChance, maxChance) == criticalDamageChance)
            {
                Damage *= criticalDamagePower;
            }
            else
            {
                Damage = _damage;
            }
        }

        public override void Attack(Warrior samurai)
        {
            samurai.TakeDamage(Damage);
            UseIndividualAbility();
        }

        public override Warrior Clone()
        {
            return new Samurai(_name, _health, _damage);
        }
    }

    class Viking : Warrior
    {
        private string _name = "Викинг";

        private int _health = 120;
        private int _damage = 13;
        private int _id = 5;

        public Viking(string name, int health, int damage) : base(name, health, damage)
        {
            Id = _id;
            Name = _name;
            Health = _health;
            Damage = _damage;
            Ability = "Особая способность - исцеляющий крик восстанавливает 6 единиц здоровья";
        }

        public void UseIndividualAbility()
        {
            int maxChance = 3;
            int minChance = 1;
            int maxHealth = 120;
            int minHealth = 0;
            int roarHealing = 6;
            int healingChance = 1;

            if (Utilites.GenerateInt(minChance, maxChance) == healingChance && Health < maxHealth && Health > minHealth)
            {
                Health += roarHealing;
            }
        }

        public override void Attack(Warrior Viking)
        {
            Viking.TakeDamage(Damage);
            UseIndividualAbility();
        }

        public override Warrior Clone()
        {
            return new Viking(_name, _health, _damage);
        }
    }

    class Battle
    {
        private Warrior _firstWarrior;
        private Warrior _secondWarrior;

        private List<Warrior> _warriors = new List<Warrior>();

        public Battle()
        {
            CreateWariors();
        }

        private void CreateWariors()
        {
            _warriors.Add(new Assassin("Убийца", 100, 18));
            _warriors.Add(new Berserk("Берсерк", 200, 10));
            _warriors.Add(new Knight("Рыцарь", 150, 20));
            _warriors.Add(new Samurai("Самурай", 100, 25));
            _warriors.Add(new Viking("Викинг", 120, 13));
        }

        private void ShowInfo()
        {
            foreach (Warrior warrior in _warriors)
            {
                warrior.ShowGladiatorInfo();
            }
        }

        public void Fight()
        {
            bool isWorking = true;

            ShowInfo();

            while (isWorking)
            {
                if (TryChooseWarrior(out _firstWarrior) == false || TryChooseWarrior(out _secondWarrior) == false)
                {
                    Console.Write("Введено некорректное значение. Введите данные гладиаторов заново: ");
                    continue;
                }

                Console.ReadKey();

                while (_firstWarrior.Health > 0 && _secondWarrior.Health > 0)
                {
                    _firstWarrior.Attack(_secondWarrior);
                    _firstWarrior.UseAbility();
                    _secondWarrior.Attack(_firstWarrior);
                    _secondWarrior.UseAbility();
                    Console.WriteLine($"{_firstWarrior.Name} здоровье {_firstWarrior.Health} <---> {_secondWarrior.Name} здоровье {_secondWarrior.Health}");
                }

                isWorking = false;
            }

            if (_firstWarrior.Health > 0 && _secondWarrior.Health <= 0)
            {
                Console.WriteLine($"{_firstWarrior.Name} - победил.");
            }
            else if (_firstWarrior.Health <= 0 && _secondWarrior.Health > 0)
            {
                Console.WriteLine($"{_secondWarrior.Name} - победил.");
            }
            else if (_firstWarrior.Health <= 0 && _secondWarrior.Health <= 0)
            {
                Console.WriteLine("Ничья");
            }
        }

        private bool TryChooseWarrior(out Warrior warriors)
        {
            bool isWorking = true;

            warriors = null;

            while (isWorking)
            {
                Console.Write("\nГладиатор номер - ");

                string userInput = Console.ReadLine();

                if (int.TryParse(userInput, out int result))
                {
                    int index = result - 1;

                    if (index >= 0 && index < _warriors.Count)
                    {
                        warriors = _warriors[index].Clone();

                        return true;
                    }

                    return false;
                }
                else
                {
                    Console.WriteLine("Такого гладиатора нет");
                }
            }

            return false;
        }
    }

    static class Utilites
    {
        static public int GenerateInt(int minValue, int maxValue)
        {
            Random random = new Random();

            return random.Next(minValue, maxValue + 1);
        }
    }
}
