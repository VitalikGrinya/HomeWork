using System;
using System.Xml.Linq;

namespace GladiatorsFights
{
    internal class Program
    {
        static void Main(string[] args)
        {
            Battle battle = new Battle();
            battle.Fight();
        }
    }

    abstract class Warrior
    {
        public Warrior(string name, int health, int attack)
        {
            Name = name;
            Health = health;
            Attack = attack;
        }

        public string Ability { get; protected set; }
        public string Name { get; protected set; }
        public int Id { get; protected set; }
        public int Health { get; protected set; }
        public int Attack { get; protected set; }

        public abstract Warrior Clone();

        public virtual void ShowWarrior()
        {
            Console.WriteLine($"{Id}. {Name}. Здоровье - {Health}. Сила - {Attack}.\n{Ability}.");
        }

        public virtual void TakeDamage(int attack)
        {
            int minHealthValue = 0;

            Health -= attack;

            if (Health < minHealthValue)
            {
                Health = minHealthValue;
            }
        }

        public virtual void MakeAttack(Warrior warrior)
        {
            warrior.TakeDamage(Attack);
            UseAbility();
        }

        public virtual void UseAbility() { }
    }

    class Assassin : Warrior
    {
        private string _name = "Убийца";
        private string _ability = "Особая способность - кровотечение отнимает 2 единицы здоровья после удара";

        private int _health = 100;
        private int _attack = 18;
        private int _id = 1;

        public Assassin(string name, int health, int attack) : base(name, health, attack)
        {
            Id = _id;
            Name = _name;
            Health = _health;
            Attack = _attack;
            Ability = _ability;
        }

        private void UseIndividualAbility()
        {
            int minChanceValue = 1;
            int maxChanceValue = 2;
            int attackChance = 1;
            int individualAttack = 5;

            if (Utilites.GenerateInt(minChanceValue, maxChanceValue) == attackChance)
            {
                Attack += individualAttack;
            }
        }

        public override void UseAbility()
        {
            UseIndividualAbility();
        }

        public override Warrior Clone()
        {
            return new Assassin(_name, _health, _attack);
        }
    }

    class Berserk : Warrior
    {
        private string _name = "Берсерк";
        private string _ability = "Особая способность - при количестве жизней меньше 50% урон увеличивается в 2 раза";

        private int _health = 200;
        private int _attack = 10;
        private int _id = 2;

        public Berserk(string name, int health, int attack) : base(name, health, attack)
        {
            Id = _id;
            Name = _name;
            Health = _health;
            Attack = _attack;
            Ability = _ability;
        }

        public void UseIndividualAbility()
        {
            int minHealthValue = 100;
            int individualAttack = 3;

            int furyAttack = _attack * individualAttack;

            if (Health <= minHealthValue)
            {
                Attack = furyAttack;
            }
            else
            {
                Attack = _attack;
            }
        }

        public override void UseAbility()
        {
            UseIndividualAbility();
        }

        public override Warrior Clone()
        {
            return new Berserk(_name, _health, _attack);
        }
    }

    class Knight : Warrior
    {
        private string _name = "Рыцарь";
        private string _ability = "Особая способность - на грани смерти восстанавливает часть жизней";

        private int _health = 150;
        private int _attack = 20;
        private int _id = 3;

        public Knight(string name, int health, int attack) : base(name, health, attack)
        {
            Id = _id;
            Name = _name;
            Health = _health;
            Attack = _attack;
            Ability = _ability;
        }

        public void UseIndividualAbility()
        {
            int deathHealthValue = 0;
            int minHealthValue = 25;
            int holyPower = 40;

            if (Health <= minHealthValue && Health > deathHealthValue)
            {
                Attack = holyPower;
            }
        }

        public override void UseAbility()
        {
            UseIndividualAbility();
        }

        public override Warrior Clone()
        {
            return new Knight(_name, _health, _attack);
        }
    }

    class Samurai : Warrior
    {
        private string _name = "Самурай";
        private string _ability = "Особая способность - шанс критического урона 33%";

        private int _health = 100;
        private int _attack = 25;
        private int _id = 4;

        public Samurai(string name, int health, int attack) : base(name, health, attack)
        {
            Id = _id;
            Name = _name;
            Health = _health;
            Attack = _attack;
            Ability = _ability;
        }

        public void UseIndividualAbility()
        {
            Attack = _attack;

            int maxChance = 3;
            int minChance = 1;
            int criticalDamageChance = 1;
            int criticalDamagePower = 2;

            if (Utilites.GenerateInt(minChance, maxChance) == criticalDamageChance)
            {
                Attack *= criticalDamagePower;
            }
            else
            {
                Attack = _attack;
            }
        }

        public override void UseAbility()
        {
            UseIndividualAbility();
        }

        public override Warrior Clone()
        {
            return new Samurai(_name, _health, _attack);
        }
    }

    class Viking : Warrior
    {
        private string _name = "Викинг";
        private string _ability = "Особая способность - исцеляющий крик восстанавливает 6 единиц здоровья";

        private int _health = 120;
        private int _attack = 13;
        private int _id = 5;

        public Viking(string name, int health, int attack) : base(name, health, attack)
        {
            Id = _id;
            Name = _name;
            Health = _health;
            Attack = _attack;
            Ability = _ability;
        }

        public void UseIndividualAbility()
        {
            int maxChance = 3;
            int minChance = 1;
            int maxHealth = 120;
            int minHealth = 0;
            int roarHealing = 6;
            int healingChance = 1;

            if (Utilites.GenerateInt(minChance, maxChance) == healingChance && Health < maxHealth && Health > minHealth)
            {
                Health += roarHealing;
            }
        }

        public override void UseAbility()
        {
            UseIndividualAbility();
        }

        public override Warrior Clone()
        {
            return new Viking(_name, _health, _attack);
        }
    }

    class Battle
    {
        private Warrior _firstWarrior;
        private Warrior _secondWarrior;

        private List<Warrior> _warriors = new List<Warrior>();

        public Battle()
        {
            CreateWariors();
        }

        public void CreateWariors()
        {
            Assassin assassin = new Assassin("Убийца", 100, 18);
            Berserk berserk = new Berserk("Берсерк", 200, 10);
            Knight knight = new Knight("Рыцарь", 150, 20);
            Samurai samurai = new Samurai("Самурай", 100, 25);
            Viking viking = new Viking("Викинг", 120, 13);

            _warriors.Add(assassin);
            _warriors.Add(berserk);
            _warriors.Add(knight);
            _warriors.Add(samurai);
            _warriors.Add(viking);
        }

        public void ShowInfo()
        {
            foreach (Warrior warrior in _warriors)
            {
                warrior.ShowWarrior();
            }
        }

        public void Fight()
        {
            bool isWorking = true;

            ShowInfo();

            while (isWorking)
            {
                if (TryChooseWarrior(out _firstWarrior) == false || TryChooseWarrior(out _secondWarrior) == false)
                {
                    Console.Write("Введено некорректное значение. Попробуй еще раз: ");
                }

                Console.ReadKey();

                while (_firstWarrior.Health > 0 && _secondWarrior.Health > 0)
                {
                    _firstWarrior.MakeAttack(_secondWarrior);
                    _firstWarrior.UseAbility();

                    _secondWarrior.MakeAttack(_firstWarrior);
                    _secondWarrior.UseAbility();

                    Console.WriteLine($"{_firstWarrior.Name} здоровье {_firstWarrior.Health} <---> {_secondWarrior.Name} здоровье {_secondWarrior.Health}");
                }

                isWorking = false;
            }

            if (_firstWarrior.Health > 0 && _secondWarrior.Health <= 0)
            {
                Console.WriteLine($"{_firstWarrior.Name} - победил.");
            }
            else if (_firstWarrior.Health <= 0 && _secondWarrior.Health > 0)
            {
                Console.WriteLine($"{_secondWarrior.Name} - победил.");
            }
            else if (_firstWarrior.Health <= 0 && _secondWarrior.Health <= 0)
            {
                Console.WriteLine("Ничья");
            }
        }

        private bool TryChooseWarrior(out Warrior warriors)
        {
            bool isWorking = true;

            warriors = null;

            while (isWorking)
            {
                Console.Write("\nГладиатор номер - ");

                string userInput = Console.ReadLine();

                if (int.TryParse(userInput, out int result))
                {
                    int index = result - 1;

                    if (index >= 0 && index < _warriors.Count)
                    {
                        warriors = _warriors[index].Clone();

                        return true;
                    }

                    return false;
                }
                else
                {
                    Console.WriteLine("Такого гладиатора нет");
                }
            }

            return false;
        }
    }

    static class Utilites
    {
        static public int GenerateInt(int minValue, int maxValue)
        {
            Random random = new Random();

            return random.Next(minValue, maxValue + 1);
        }
    }
}
